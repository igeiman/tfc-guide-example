# Terraform Cloud  Example

This is an example Terraform configuration intended for use with the [Terraform Cloud Getting Started Guide](https://learn.hashicorp.com/terraform/cloud-gettingstarted/tfc_overview). The configuration demonstarates 3 ways of deploying Terraform configuration using TF Cloud. The main focus of this example is to ensure the proposed deployment can be used with OpsGuru Cloud LaunchPad (CLP) solution on AWS. 

The main challenge of using CLP with Terraform Cloud (TFC) is CLP's extensive use of environment variables to share common parameters with all the modules. TF Cloud by default is running TF binary in a remote envrioenment triggered by VCS changes. Thus the CLP's implamentation of TF_VARs sharing based on make files will not get executed if the default VCS driven flow of TFC is executed.

## What will this do?

This is a simple Terraform configuration that will create one AWS user  [IAM](https://aws.amazon.com/iam/) your AWS account.
This example is heavily influenced by [Marko's implementation of CLP for TFC on GCP](https://github.com/ops-guru/gcp-clp-pci-dss-profile-tfe-example)
Go through the [README](https://github.com/ops-guru/gcp-clp-pci-dss-profile-tfe-example/blob/master/README.md) of the repo above to understand how TFC Workspaces are provisioned and how AWS credentials are pushed to the Workspaces.

The folder structure of this example is below:
- tfc-example/test-env - running Terraform configuration loacally, only TF state is stored and syncronized remotely in TFC. The workflow and the approval are done locally. This mode is the easiest to be adopted by CLP. While VCS is connected with TFC in this mode, the changes in VCS do not trigger the workflow and the actual configrations are those that are on the local machine, _not_ in VCS. 

- tfc-example/test-env-remote - running  Terraform configuration remotely on TFC, the workflow is triggered by VCS, the approval process happens in TFC UI only.
Only workspace bootstrap happens locally through workspaces.py utility created by Marko. Workspaces can be bootstrapped manually through TFC UI. (not recommended). This mode allows full integration with VCS workflow but will not support TF_VARs dynamically created by AWS CLP's makefiles. Unless these variables can be populated as part of TFC workspace bootstrapping process, this mode might not be compatible with AWS CLP.

- tfc-example/test-tg - example of TFC and Terragrunt integration based on [CLP v2.0](https://github.com/ops-guru/aws-clp-v2) and [Gruntwork tutorial](https://gruntwork.io/guides/foundations/how-to-use-gruntwork-infrastructure-as-code-library#integration_with_tfc_tfe). In this example, TFC Workspace is _not_ using VCS as a source of truth. The terragrunt commands trigger underlying terraform commands which in turn run remotely in TFC workspace. The remote runs and approval process are visible both locally and via TFC UI. TFC stores Runs` history and remote state. This mode can be integrated with AWS CLP v2 through storing local parameters in *auto.tfvars file that TFC uploads into the remote execution containder as part of TF configuration. TV_VARS and *.tfvars files are ignored.  The terragrunt.auto.tfvars file is generated by terrugrunt from the parent parameters file in the root folder tfc-example\test-tfc-terragrunt (vars.yaml in this example).


## What are the prerequisites?


All the pre-Requisites from the [README](https://github.com/ops-guru/gcp-clp-pci-dss-profile-tfe-example/blob/master/README.md) should be completed prior to use of the example.

Note: you will need Admin permissions on your GitHub repo to integrate it with TFC.


## Deployment flows in different modes

1. Running tfc-example/test-tfc-local, [local CLI driven workflow](https://www.terraform.io/docs/cloud/workspaces/settings.html#execution-mode)
 Export TFE_OAUTH_TOKEN_ID TFE_SSH_KEY as explained in the link in the Prerequisites section
 Create a test-tfc-local workspace using the workspaces utiliy in repo's root:
  ./workspaces.py --org <name of your org in TFC>  --tfe "app.terraform.io" create --oauth-token-id $TFE_OAUTH_TOKEN_ID --ssh-key $TFE_SSH_KEY test-tfc-local
  Update the execution mode to local. TFC will be used to store the state only, all the execution will be done on a local machine
  ./workspaces.py --org <name of your org in TFC> --tfe "app.terraform.io" update --exec-mode local test-tfc-local


2. Running ttfc-example/test-tfc-remote, [remote mode, VCS driven workflow](https://www.terraform.io/docs/cloud/run/ui.html)

3. Running tfc-example/test-tfc-terragrunt via Terragrunt, [remote mode, CLI driven workflow](https://www.terraform.io/docs/cloud/run/cli.html)

You must have an AWS account and provide your AWS Access Key ID and AWS Secret Access Key to Terraform Cloud. Terraform Cloud encrypts and stores variables using [Vault](https://www.vaultproject.io/). For more information on how to store variables in Terraform Cloud, see [our variable documentation](https://www.terraform.io/docs/cloud/workspaces/variables.html).

The values for `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` should be saved as environment variables on your workspace.
